"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = copy;

var _quality = require("./quality");

var hasOwnProperty = Object.prototype.hasOwnProperty;

function copy(source, destination) {
  var stackSource = [];
  var stackDest = [];

  if (destination) {
    if ((0, _quality.isTypedArray)(destination) || (0, _quality.isBufferArray)(destination)) {
      throw new Error('copy: TypedArray destination cannot be mutated');
    }

    if (source === destination) {
      throw new Error('copy: Source and destination are identical.');
    } // Empty the destination object


    if ((0, _quality.isArray)(destination)) {
      destination.length = 0;
    } else {
      Object.keys(destination).forEach(function (key) {
        if (key !== '$$hashKey') {
          delete destination[key];
        }
      });
    }

    stackSource.push(source);
    stackDest.push(destination);
    return copyRecurse(source, destination);
  }

  return copyElement(source);

  function copyRecurse(source, destination) {
    var h = destination.$$hashKey;
    var key;

    if ((0, _quality.isArray)(source)) {
      for (var i = 0, ii = source.length; i < ii; i++) {
        destination.push(copyElement(source[i]));
      }
    } else if ((0, _quality.isBlankObject)(source)) {
      // createMap() fast path --- Safe to avoid hasOwnProperty check because prototype chain is empty
      for (key in source) {
        destination[key] = copyElement(source[key]);
      }
    } else if (source && typeof source.hasOwnProperty === 'function') {
      // Slow path, which must rely on hasOwnProperty
      for (key in source) {
        if (source.hasOwnProperty(key)) {
          destination[key] = copyElement(source[key]);
        }
      }
    } else {
      // Slowest path --- hasOwnProperty can't be called as a method
      for (key in source) {
        if (hasOwnProperty.call(source, key)) {
          destination[key] = copyElement(source[key]);
        }
      }
    }

    return destination;
  }

  function copyElement(source) {
    // Simple values
    if (!(0, _quality.isObject)(source) && !(0, _quality.isArray)(source)) {
      return source;
    } // Already copied values


    var index = stackSource.indexOf(source);

    if (index !== -1) {
      return stackDest[index];
    }

    if ((0, _quality.isWindow)(source)) {
      throw new Error('copy: Cannot making copies of Window.');
    }

    var needsRecurse = false;
    var destination = copyType(source);

    if (destination === undefined) {
      destination = (0, _quality.isArray)(source) ? [] : Object.create(Object.getPrototypeOf(source));
      needsRecurse = true;
    }

    stackSource.push(source);
    stackDest.push(destination);
    return needsRecurse ? copyRecurse(source, destination) : destination;
  }

  function copyType(source) {
    switch (Object.prototype.toString.call(source)) {
      case '[object Int8Array]':
      case '[object Int16Array]':
      case '[object Int32Array]':
      case '[object Float32Array]':
      case '[object Float64Array]':
      case '[object Uint8Array]':
      case '[object Uint8ClampedArray]':
      case '[object Uint16Array]':
      case '[object Uint32Array]':
        return new source.constructor(copyElement(source.buffer), source.byteOffset, source.length);

      case '[object ArrayBuffer]':
        //Support: IE10
        if (!source.slice) {
          var copied = new ArrayBuffer(source.byteLength);
          new Uint8Array(copied).set(new Uint8Array(source));
          return copied;
        }

        return source.slice(0);

      case '[object Boolean]':
      case '[object Number]':
      case '[object String]':
      case '[object Date]':
        return new source.constructor(source.valueOf());

      case '[object RegExp]':
        var re = new RegExp(source.source, source.toString().match(/[^\/]*$/)[0]);
        re.lastIndex = source.lastIndex;
        return re;

      case '[object Blob]':
        return new source.constructor([source], {
          type: source.type
        });
    }

    if ((0, _quality.isFunction)(source.cloneNode)) {
      return source.cloneNode(true);
    }
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9jb3B5LnRzIl0sIm5hbWVzIjpbImhhc093blByb3BlcnR5IiwiT2JqZWN0IiwicHJvdG90eXBlIiwiY29weSIsInNvdXJjZSIsImRlc3RpbmF0aW9uIiwic3RhY2tTb3VyY2UiLCJzdGFja0Rlc3QiLCJFcnJvciIsImxlbmd0aCIsImtleXMiLCJmb3JFYWNoIiwia2V5IiwicHVzaCIsImNvcHlSZWN1cnNlIiwiY29weUVsZW1lbnQiLCJoIiwiJCRoYXNoS2V5IiwiaSIsImlpIiwiY2FsbCIsImluZGV4IiwiaW5kZXhPZiIsIm5lZWRzUmVjdXJzZSIsImNvcHlUeXBlIiwidW5kZWZpbmVkIiwiY3JlYXRlIiwiZ2V0UHJvdG90eXBlT2YiLCJ0b1N0cmluZyIsImNvbnN0cnVjdG9yIiwiYnVmZmVyIiwiYnl0ZU9mZnNldCIsInNsaWNlIiwiY29waWVkIiwiQXJyYXlCdWZmZXIiLCJieXRlTGVuZ3RoIiwiVWludDhBcnJheSIsInNldCIsInZhbHVlT2YiLCJyZSIsIlJlZ0V4cCIsIm1hdGNoIiwibGFzdEluZGV4IiwidHlwZSIsImNsb25lTm9kZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUVBLElBQU1BLGNBQWMsR0FBR0MsTUFBTSxDQUFDQyxTQUFQLENBQWlCRixjQUF4Qzs7QUFFZSxTQUFTRyxJQUFULENBQWNDLE1BQWQsRUFBMkJDLFdBQTNCLEVBQThDO0FBQzVELE1BQUlDLFdBQXVCLEdBQUcsRUFBOUI7QUFDQSxNQUFJQyxTQUFxQixHQUFHLEVBQTVCOztBQUVBLE1BQUlGLFdBQUosRUFBaUI7QUFDaEIsUUFBSSwyQkFBYUEsV0FBYixLQUE2Qiw0QkFBY0EsV0FBZCxDQUFqQyxFQUE2RDtBQUM1RCxZQUFNLElBQUlHLEtBQUosQ0FBVSxnREFBVixDQUFOO0FBQ0E7O0FBQ0QsUUFBSUosTUFBTSxLQUFLQyxXQUFmLEVBQTRCO0FBQzNCLFlBQU0sSUFBSUcsS0FBSixDQUFVLDZDQUFWLENBQU47QUFDQSxLQU5lLENB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QSxjQUFJQyxVQUFKLENBQWVILE1BQWYsRUFBdUJJLEdBQXZCLENBQTJCLElBQUlELFVBQUosQ0FBZWhDLE1BQWYsQ0FBM0I7QUFDQSxpQkFBTzZCLE1BQVA7QUFDQTs7QUFDRCxlQUFPN0IsTUFBTSxDQUFDNEIsS0FBUCxDQUFhLENBQWIsQ0FBUDs7QUFFRCxXQUFLLGtCQUFMO0FBQ0EsV0FBSyxpQkFBTDtBQUNBLFdBQUssaUJBQUw7QUFDQSxXQUFLLGVBQUw7QUFDQyxlQUFPLElBQUk1QixNQUFNLENBQUN5QixXQUFYLENBQXVCekIsTUFBTSxDQUFDa0MsT0FBUCxFQUF2QixDQUFQOztBQUVELFdBQUssaUJBQUw7QUFDQyxZQUFJQyxFQUFFLEdBQUcsSUFBSUMsTUFBSixDQUFXcEMsTUFBTSxDQUFDQSxNQUFsQixFQUEwQkEsTUFBTSxDQUFDd0IsUUFBUCxHQUFrQmEsS0FBbEIsQ0FBd0IsU0FBeEIsRUFBbUMsQ0FBbkMsQ0FBMUIsQ0FBVDtBQUNBRixRQUFBQSxFQUFFLENBQUNHLFNBQUgsR0FBZXRDLE1BQU0sQ0FBQ3NDLFNBQXRCO0FBQ0EsZUFBT0gsRUFBUDs7QUFFRCxXQUFLLGVBQUw7QUFDQyxlQUFPLElBQUluQyxNQUFNLENBQUN5QixXQUFYLENBQXVCLENBQUN6QixNQUFELENBQXZCLEVBQWlDO0FBQUV1QyxVQUFBQSxJQUFJLEVBQUV2QyxNQUFNLENBQUN1QztBQUFmLFNBQWpDLENBQVA7QUFqQ0Y7O0FBb0NBLFFBQUkseUJBQVd2QyxNQUFNLENBQUN3QyxTQUFsQixDQUFKLEVBQWtDO0FBQ2pDLGFBQU94QyxNQUFNLENBQUN3QyxTQUFQLENBQWlCLElBQWpCLENBQVA7QUFDQTtBQUNEO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpc0FycmF5LCBpc0J1ZmZlckFycmF5LCBpc0JsYW5rT2JqZWN0LCBpc0Z1bmN0aW9uLCBpc09iamVjdCwgaXNUeXBlZEFycmF5LCBpc1dpbmRvdyB9IGZyb20gJy4vcXVhbGl0eSc7XG5cbmNvbnN0IGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTtcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gY29weShzb3VyY2U6IGFueSwgZGVzdGluYXRpb24/OiBhbnkpIHtcblx0bGV0IHN0YWNrU291cmNlOiBBcnJheTxhbnk+ID0gW107XG5cdGxldCBzdGFja0Rlc3Q6IEFycmF5PGFueT4gPSBbXTtcblxuXHRpZiAoZGVzdGluYXRpb24pIHtcblx0XHRpZiAoaXNUeXBlZEFycmF5KGRlc3RpbmF0aW9uKSB8fCBpc0J1ZmZlckFycmF5KGRlc3RpbmF0aW9uKSkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKCdjb3B5OiBUeXBlZEFycmF5IGRlc3RpbmF0aW9uIGNhbm5vdCBiZSBtdXRhdGVkJyk7XG5cdFx0fVxuXHRcdGlmIChzb3VyY2UgPT09IGRlc3RpbmF0aW9uKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ2NvcHk6IFNvdXJjZSBhbmQgZGVzdGluYXRpb24gYXJlIGlkZW50aWNhbC4nKTtcblx0XHR9XG5cblx0XHQvLyBFbXB0eSB0aGUgZGVzdGluYXRpb24gb2JqZWN0XG5cdFx0aWYgKGlzQXJyYXkoZGVzdGluYXRpb24pKSB7XG5cdFx0XHRkZXN0aW5hdGlvbi5sZW5ndGggPSAwO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRPYmplY3Qua2V5cyhkZXN0aW5hdGlvbikuZm9yRWFjaCgoa2V5KSA9PiB7XG5cdFx0XHRcdGlmIChrZXkgIT09ICckJGhhc2hLZXknKSB7XG5cdFx0XHRcdFx0ZGVsZXRlIGRlc3RpbmF0aW9uW2tleV07XG5cdFx0XHRcdH1cblx0XHRcdH0pO1xuXHRcdH1cblxuXHRcdHN0YWNrU291cmNlLnB1c2goc291cmNlKTtcblx0XHRzdGFja0Rlc3QucHVzaChkZXN0aW5hdGlvbik7XG5cdFx0cmV0dXJuIGNvcHlSZWN1cnNlKHNvdXJjZSwgZGVzdGluYXRpb24pO1xuXHR9XG5cblx0cmV0dXJuIGNvcHlFbGVtZW50KHNvdXJjZSk7XG5cblx0ZnVuY3Rpb24gY29weVJlY3Vyc2Uoc291cmNlOiBhbnksIGRlc3RpbmF0aW9uOiBhbnkpIHtcblx0XHR2YXIgaCA9IGRlc3RpbmF0aW9uLiQkaGFzaEtleTtcblx0XHR2YXIga2V5O1xuXHRcdGlmIChpc0FycmF5KHNvdXJjZSkpIHtcblx0XHRcdGZvciAodmFyIGkgPSAwLCBpaSA9IHNvdXJjZS5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7XG5cdFx0XHRcdGRlc3RpbmF0aW9uLnB1c2goY29weUVsZW1lbnQoc291cmNlW2ldKSk7XG5cdFx0XHR9XG5cdFx0fSBlbHNlIGlmIChpc0JsYW5rT2JqZWN0KHNvdXJjZSkpIHtcblx0XHRcdC8vIGNyZWF0ZU1hcCgpIGZhc3QgcGF0aCAtLS0gU2FmZSB0byBhdm9pZCBoYXNPd25Qcm9wZXJ0eSBjaGVjayBiZWNhdXNlIHByb3RvdHlwZSBjaGFpbiBpcyBlbXB0eVxuXHRcdFx0Zm9yIChrZXkgaW4gc291cmNlKSB7XG5cdFx0XHRcdGRlc3RpbmF0aW9uW2tleV0gPSBjb3B5RWxlbWVudChzb3VyY2Vba2V5XSk7XG5cdFx0XHR9XG5cdFx0fSBlbHNlIGlmIChzb3VyY2UgJiYgdHlwZW9mIHNvdXJjZS5oYXNPd25Qcm9wZXJ0eSA9PT0gJ2Z1bmN0aW9uJykge1xuXHRcdFx0Ly8gU2xvdyBwYXRoLCB3aGljaCBtdXN0IHJlbHkgb24gaGFzT3duUHJvcGVydHlcblx0XHRcdGZvciAoa2V5IGluIHNvdXJjZSkge1xuXHRcdFx0XHRpZiAoc291cmNlLmhhc093blByb3BlcnR5KGtleSkpIHtcblx0XHRcdFx0XHRkZXN0aW5hdGlvbltrZXldID0gY29weUVsZW1lbnQoc291cmNlW2tleV0pO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fSBlbHNlIHtcblx0XHRcdC8vIFNsb3dlc3QgcGF0aCAtLS0gaGFzT3duUHJvcGVydHkgY2FuJ3QgYmUgY2FsbGVkIGFzIGEgbWV0aG9kXG5cdFx0XHRmb3IgKGtleSBpbiBzb3VyY2UpIHtcblx0XHRcdFx0aWYgKGhhc093blByb3BlcnR5LmNhbGwoc291cmNlLCBrZXkpKSB7XG5cdFx0XHRcdFx0ZGVzdGluYXRpb25ba2V5XSA9IGNvcHlFbGVtZW50KHNvdXJjZVtrZXldKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiBkZXN0aW5hdGlvbjtcblx0fVxuXG5cdGZ1bmN0aW9uIGNvcHlFbGVtZW50KHNvdXJjZTogYW55KTogYW55IHtcblx0XHQvLyBTaW1wbGUgdmFsdWVzXG5cdFx0aWYgKCFpc09iamVjdChzb3VyY2UpICYmICFpc0FycmF5KHNvdXJjZSkpIHtcblx0XHRcdHJldHVybiBzb3VyY2U7XG5cdFx0fVxuXG5cdFx0Ly8gQWxyZWFkeSBjb3BpZWQgdmFsdWVzXG5cdFx0dmFyIGluZGV4ID0gc3RhY2tTb3VyY2UuaW5kZXhPZihzb3VyY2UpO1xuXHRcdGlmIChpbmRleCAhPT0gLTEpIHtcblx0XHRcdHJldHVybiBzdGFja0Rlc3RbaW5kZXhdO1xuXHRcdH1cblxuXHRcdGlmIChpc1dpbmRvdyhzb3VyY2UpKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ2NvcHk6IENhbm5vdCBtYWtpbmcgY29waWVzIG9mIFdpbmRvdy4nKTtcblx0XHR9XG5cblx0XHR2YXIgbmVlZHNSZWN1cnNlID0gZmFsc2U7XG5cdFx0dmFyIGRlc3RpbmF0aW9uID0gY29weVR5cGUoc291cmNlKTtcblxuXHRcdGlmIChkZXN0aW5hdGlvbiA9PT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRkZXN0aW5hdGlvbiA9IGlzQXJyYXkoc291cmNlKSA/IFtdIDogT2JqZWN0LmNyZWF0ZShPYmplY3QuZ2V0UHJvdG90eXBlT2Yoc291cmNlKSk7XG5cdFx0XHRuZWVkc1JlY3Vyc2UgPSB0cnVlO1xuXHRcdH1cblxuXHRcdHN0YWNrU291cmNlLnB1c2goc291cmNlKTtcblx0XHRzdGFja0Rlc3QucHVzaChkZXN0aW5hdGlvbik7XG5cblx0XHRyZXR1cm4gbmVlZHNSZWN1cnNlID8gY29weVJlY3Vyc2Uoc291cmNlLCBkZXN0aW5hdGlvbikgOiBkZXN0aW5hdGlvbjtcblx0fVxuXG5cdGZ1bmN0aW9uIGNvcHlUeXBlKHNvdXJjZTogYW55KSB7XG5cdFx0c3dpdGNoIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoc291cmNlKSkge1xuXHRcdFx0Y2FzZSAnW29iamVjdCBJbnQ4QXJyYXldJzpcblx0XHRcdGNhc2UgJ1tvYmplY3QgSW50MTZBcnJheV0nOlxuXHRcdFx0Y2FzZSAnW29iamVjdCBJbnQzMkFycmF5XSc6XG5cdFx0XHRjYXNlICdbb2JqZWN0IEZsb2F0MzJBcnJheV0nOlxuXHRcdFx0Y2FzZSAnW29iamVjdCBGbG9hdDY0QXJyYXldJzpcblx0XHRcdGNhc2UgJ1tvYmplY3QgVWludDhBcnJheV0nOlxuXHRcdFx0Y2FzZSAnW29iamVjdCBVaW50OENsYW1wZWRBcnJheV0nOlxuXHRcdFx0Y2FzZSAnW29iamVjdCBVaW50MTZBcnJheV0nOlxuXHRcdFx0Y2FzZSAnW29iamVjdCBVaW50MzJBcnJheV0nOlxuXHRcdFx0XHRyZXR1cm4gbmV3IHNvdXJjZS5jb25zdHJ1Y3Rvcihjb3B5RWxlbWVudChzb3VyY2UuYnVmZmVyKSwgc291cmNlLmJ5dGVPZmZzZXQsIHNvdXJjZS5sZW5ndGgpO1xuXG5cdFx0XHRjYXNlICdbb2JqZWN0IEFycmF5QnVmZmVyXSc6XG5cdFx0XHRcdC8vU3VwcG9ydDogSUUxMFxuXHRcdFx0XHRpZiAoIXNvdXJjZS5zbGljZSkge1xuXHRcdFx0XHRcdHZhciBjb3BpZWQgPSBuZXcgQXJyYXlCdWZmZXIoc291cmNlLmJ5dGVMZW5ndGgpO1xuXHRcdFx0XHRcdG5ldyBVaW50OEFycmF5KGNvcGllZCkuc2V0KG5ldyBVaW50OEFycmF5KHNvdXJjZSkpO1xuXHRcdFx0XHRcdHJldHVybiBjb3BpZWQ7XG5cdFx0XHRcdH1cblx0XHRcdFx0cmV0dXJuIHNvdXJjZS5zbGljZSgwKTtcblxuXHRcdFx0Y2FzZSAnW29iamVjdCBCb29sZWFuXSc6XG5cdFx0XHRjYXNlICdbb2JqZWN0IE51bWJlcl0nOlxuXHRcdFx0Y2FzZSAnW29iamVjdCBTdHJpbmddJzpcblx0XHRcdGNhc2UgJ1tvYmplY3QgRGF0ZV0nOlxuXHRcdFx0XHRyZXR1cm4gbmV3IHNvdXJjZS5jb25zdHJ1Y3Rvcihzb3VyY2UudmFsdWVPZigpKTtcblxuXHRcdFx0Y2FzZSAnW29iamVjdCBSZWdFeHBdJzpcblx0XHRcdFx0dmFyIHJlID0gbmV3IFJlZ0V4cChzb3VyY2Uuc291cmNlLCBzb3VyY2UudG9TdHJpbmcoKS5tYXRjaCgvW15cXC9dKiQvKVswXSk7XG5cdFx0XHRcdHJlLmxhc3RJbmRleCA9IHNvdXJjZS5sYXN0SW5kZXg7XG5cdFx0XHRcdHJldHVybiByZTtcblxuXHRcdFx0Y2FzZSAnW29iamVjdCBCbG9iXSc6XG5cdFx0XHRcdHJldHVybiBuZXcgc291cmNlLmNvbnN0cnVjdG9yKFtzb3VyY2VdLCB7IHR5cGU6IHNvdXJjZS50eXBlIH0pO1xuXHRcdH1cblxuXHRcdGlmIChpc0Z1bmN0aW9uKHNvdXJjZS5jbG9uZU5vZGUpKSB7XG5cdFx0XHRyZXR1cm4gc291cmNlLmNsb25lTm9kZSh0cnVlKTtcblx0XHR9XG5cdH1cbn0iXX0=